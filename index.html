<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像編集ツール</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #editor {
            display: grid;
            gap: 1px;
            margin: 20px;
        }
        .cell {
            width: 20px;
            height: 20px;
            background-color: white;
            border: 1px solid #ddd;
        }
        .cell:hover {
            border: 1px solid #aaa;
        }
        #tools {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>画像編集ツール</h1>

<div id="editor"></div>

<div id="tools">
    <label>
        グリッドサイズ:
        <input type="number" id="gridSize" value="16" min="4" max="64">
    </label>
    <button id="updateGrid">更新</button>
    <label>
        <span>色:</span>
        <input type="color" id="currentColor" value="#000000">
    </label>
    <button id="clear">全消去</button>
    <button id="export">画像を保存</button>
    <button id="import">画像を読み込み</button>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;">
    <button id="pickColor">色をコピー</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const editor = document.getElementById('editor');
    const gridSizeInput = document.getElementById('gridSize');
    const updateGridButton = document.getElementById('updateGrid');
    const currentColorInput = document.getElementById('currentColor');
    const clearButton = document.getElementById('clear');
    const exportButton = document.getElementById('export');
    const importButton = document.getElementById('import');
    const imageLoader = document.getElementById('imageLoader');
    const pickColorButton = document.getElementById('pickColor');
    const canvas = document.getElementById('canvas');

    let currentColor = '#000000';
    let isPickingColor = false;

    // グリッド生成
    function createGrid(size) {
        editor.innerHTML = ''; // 初期化
        editor.style.gridTemplateColumns = `repeat(${size}, 20px)`;
        editor.style.gridTemplateRows = `repeat(${size}, 20px)`;

        for (let i = 0; i < size * size; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.addEventListener('mousedown', (e) => {
                if (isPickingColor) {
                    const bgColor = window.getComputedStyle(cell).backgroundColor;
                    currentColor = rgbToHex(bgColor);
                    currentColorInput.value = currentColor;
                    isPickingColor = false;
                } else {
                    cell.style.backgroundColor = currentColor;
                }
            });
            cell.addEventListener('mouseover', (e) => {
                if (e.buttons === 1 && !isPickingColor) cell.style.backgroundColor = currentColor;
            });
            editor.appendChild(cell);
        }
    }

    // RGBカラーを16進カラーコードに変換
    function rgbToHex(rgb) {
        const [r, g, b] = rgb.match(/\d+/g).map(Number);
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }

    // 初期化
    createGrid(parseInt(gridSizeInput.value));

    // グリッドサイズ変更
    updateGridButton.addEventListener('click', () => {
        const size = parseInt(gridSizeInput.value);
        if (size >= 4 && size <= 64) {
            createGrid(size);
        } else {
            alert("グリッドサイズは4から64の間で指定してください。");
        }
    });

    // 色変更
    currentColorInput.addEventListener('input', (e) => {
        currentColor = e.target.value;
    });

    // 全消去
    clearButton.addEventListener('click', () => {
        document.querySelectorAll('.cell').forEach(cell => {
            cell.style.backgroundColor = 'white';
        });
    });

    // 画像を保存
    exportButton.addEventListener('click', () => {
        const size = parseInt(gridSizeInput.value);
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        const cells = document.querySelectorAll('.cell');
        cells.forEach((cell, index) => {
            const x = index % size;
            const y = Math.floor(index / size);
            const color = window.getComputedStyle(cell).backgroundColor;
            ctx.fillStyle = color;
            ctx.fillRect(x, y, 1, 1);
        });

        const link = document.createElement('a');
        link.download = 'grid_image.png';
        link.href = canvas.toDataURL();
        link.click();
    });

    // 画像を読み込み
    importButton.addEventListener('click', () => {
        imageLoader.click();
    });

    imageLoader.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const img = new Image();
            const size = parseInt(gridSizeInput.value);
            img.onload = () => {
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, size, size);

                const imageData = ctx.getImageData(0, 0, size, size);
                const cells = document.querySelectorAll('.cell');
                for (let i = 0; i < cells.length; i++) {
                    const r = imageData.data[i * 4];
                    const g = imageData.data[i * 4 + 1];
                    const b = imageData.data[i * 4 + 2];
                    cells[i].style.backgroundColor = `rgb(${r},${g},${b})`;
                }
            };
            img.src = URL.createObjectURL(file);
        }
    });

    // 色をコピー
    pickColorButton.addEventListener('click', () => {
        isPickingColor = true;
        alert("コピーしたいセルをクリックしてください。");
    });
</script>

</body>
</html>
