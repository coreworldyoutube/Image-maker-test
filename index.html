<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ドット絵エディター</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        .grid {
            display: grid;
            gap: 1px;
            position: absolute;
            top: 0;
            left: 0;
        }
        .cell {
            width: 20px;
            height: 20px;
            background-color: transparent;
            border: 1px solid #ccc;
        }
        #color-picker, #zoom-slider, #transparency-slider {
            margin-top: 10px;
        }
        #tools {
            margin-top: 10px;
        }
        #size-input {
            margin-top: 10px;
        }
        #download {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>ドット絵エディター</h1>

<div class="container">
    <div id="grid" class="grid"></div>
</div>

<!-- RGB選択 -->
<div>
    <label>赤: <input type="range" id="red-slider" min="0" max="255" value="0"></label>
    <label>緑: <input type="range" id="green-slider" min="0" max="255" value="0"></label>
    <label>青: <input type="range" id="blue-slider" min="0" max="255" value="0"></label>
    <label>透過性: <input type="range" id="transparency-slider" min="0" max="100" value="100"></label>
</div>

<!-- ズームとツール -->
<div id="tools">
    <button id="eraser">消しゴム</button>
    <label for="zoom-slider">ズーム:</label>
    <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1">
    <label for="size-input">保存サイズ (px):</label>
    <input type="number" id="size-input" value="320" min="16" step="16">
    <button id="download">画像保存</button>
</div>

<input type="file" id="upload" accept="image/*" />

<script>
    let gridSize = 16; // 初期のグリッドサイズ
    let zoomLevel = 1; // ズームの初期レベル
    const grid = document.getElementById('grid');
    const colorPicker = document.getElementById('color-picker');
    const eraserButton = document.getElementById('eraser');
    let isErasing = false; // 消しゴムのオン・オフ状態
    let currentColor = { r: 0, g: 0, b: 0, a: 100 }; // 現在の色

    // RGBスライダーの変更に対応
    document.getElementById('red-slider').addEventListener('input', updateColor);
    document.getElementById('green-slider').addEventListener('input', updateColor);
    document.getElementById('blue-slider').addEventListener('input', updateColor);
    document.getElementById('transparency-slider').addEventListener('input', updateColor);

    function updateColor() {
        currentColor.r = document.getElementById('red-slider').value;
        currentColor.g = document.getElementById('green-slider').value;
        currentColor.b = document.getElementById('blue-slider').value;
        currentColor.a = document.getElementById('transparency-slider').value;
    }

    // グリッドを作成
    function createGrid(cols, rows) {
        grid.innerHTML = ''; // グリッドをクリア
        grid.style.gridTemplateColumns = `repeat(${cols}, 20px)`;
        grid.style.gridTemplateRows = `repeat(${rows}, 20px)`;

        for (let i = 0; i < cols * rows; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            grid.appendChild(cell);
        }
    }

    // ドットを塗る処理
    grid.addEventListener('click', (e) => {
        if (e.target.classList.contains('cell')) {
            if (isErasing) {
                // 消しゴムがオンの場合、セルの背景を透明に
                e.target.style.backgroundColor = 'transparent';
            } else {
                // 選択された色を塗る
                const color = `rgba(${currentColor.r}, ${currentColor.g}, ${currentColor.b}, ${currentColor.a / 100})`;
                e.target.style.backgroundColor = color;
            }
        }
    });

    // 消しゴム機能のトグル
    eraserButton.addEventListener('click', () => {
        isErasing = !isErasing;
        eraserButton.style.backgroundColor = isErasing ? 'lightgray' : '';
    });

    // ズームスライダーの変更に対応
    document.getElementById('zoom-slider').addEventListener('input', (e) => {
        zoomLevel = parseFloat(e.target.value);
        updateGridSize();
    });

    // グリッドサイズの更新
    function updateGridSize() {
        const cols = Math.floor(grid.offsetWidth / (20 * zoomLevel));
        const rows = Math.floor(grid.offsetHeight / (20 * zoomLevel));
        createGrid(cols, rows);
    }

    // グリッドを移動（パン）するためのマウスドラッグイベント
    let isDragging = false;
    let startX, startY;

    grid.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
    });

    grid.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            grid.style.transform = `translate(${dx}px, ${dy}px)`;
        }
    });

    grid.addEventListener('mouseup', () => {
        isDragging = false;
    });

    // 画像読み込み処理
    document.getElementById('upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const img = new Image();
            img.onload = () => {
                const width = Math.floor(img.width / 16) * 16;
                const height = Math.floor(img.height / 16) * 16;
                img.width = width;
                img.height = height;

                const cols = width / (20 * zoomLevel);
                const rows = height / (20 * zoomLevel);
                createGrid(cols, rows);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const imageData = ctx.getImageData(0, 0, width, height);
                const cells = grid.getElementsByClassName('cell');
                for (let i = 0; i < cols * rows; i++) {
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    const pixelIndex = (row * width + col) * 4;

                    if (pixelIndex < imageData.data.length) {
                        const r = imageData.data[pixelIndex];
                        const g = imageData.data[pixelIndex + 1];
                        const b = imageData.data[pixelIndex + 2];
                        const a = imageData.data[pixelIndex + 3];

                        if (a > 0) {
                            const color = `rgba(${r}, ${g}, ${b}, ${a / 255})`;
                            cells[i].style.backgroundColor = color;
                        } else {
                            cells[i].style.backgroundColor = 'transparent';
                        }
                    }
                }
            };
            img.src = URL.createObjectURL(file);
        }
    });

    // 画像保存処理
    document.getElementById('download').addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        const size = parseInt(document.getElementById('size-input').value);
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        const cells = grid.getElementsByClassName('cell');
        const scaleFactor = size / (gridSize * 20 * zoomLevel);  
        Array.from(cells).forEach((cell, i) => {
            const x = (i % gridSize) * 20 * scaleFactor;
            const y = Math.floor(i / gridSize) * 20 * scaleFactor;
            ctx.fillStyle = cell.style.backgroundColor || 'transparent';
            ctx.fillRect(x, y, 20 * scaleFactor, 20 * scaleFactor);
        });

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'dot-art.png';
        link.click();
    });
</script>

</body>
</html>
