<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ドット絵エディター</title>
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(16, 20px);
            grid-template-rows: repeat(16, 20px);
            gap: 1px;
        }
        .cell {
            width: 20px;
            height: 20px;
            background-color: white;
            border: 1px solid #ccc;
        }
        #color-picker {
            margin-top: 10px;
        }
        #upload {
            margin-top: 10px;
        }
        #tools {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>ドット絵エディター</h1>

<div id="grid" class="grid"></div>

<select id="color-picker">
    <option value="black">黒</option>
    <option value="red">赤</option>
    <option value="blue">青</option>
    <option value="green">緑</option>
    <option value="yellow">黄色</option>
    <option value="white">白</option>
</select>

<input type="file" id="upload" accept="image/*" />

<div id="tools">
    <button id="eraser">消しゴム</button>
</div>

<button id="download">画像保存</button>

<script>
    // グリッドサイズの設定
    const gridSize = 16; // 16x16のグリッド
    const grid = document.getElementById('grid');
    const colorPicker = document.getElementById('color-picker');
    const eraserButton = document.getElementById('eraser');
    let isErasing = false; // 消しゴムがオンかどうかを追跡

    // グリッドを作成
    for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        grid.appendChild(cell);
    }

    // ドットを塗る処理
    grid.addEventListener('click', (e) => {
        if (e.target.classList.contains('cell')) {
            if (isErasing) {
                // 消しゴムがオンの場合、セルの背景を白に
                e.target.style.backgroundColor = 'white';
            } else {
                // 消しゴムがオフの場合、選択した色を塗る
                const selectedColor = colorPicker.value;
                e.target.style.backgroundColor = selectedColor;
            }
        }
    });

    // 消しゴムのトグル
    eraserButton.addEventListener('click', () => {
        isErasing = !isErasing;
        eraserButton.style.backgroundColor = isErasing ? 'lightgray' : ''; // 消しゴム選択時に色を変える
    });

    // 画像読み込み処理
    document.getElementById('upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const img = new Image();
            img.onload = () => {
                // 画像のサイズを16の倍数に調整
                const width = Math.floor(img.width / 16) * 16;
                const height = Math.floor(img.height / 16) * 16;
                img.width = width;
                img.height = height;

                // 画像をキャンバスに描画
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // キャンバスのピクセルデータを取得し、グリッドに反映
                const imageData = ctx.getImageData(0, 0, width, height);
                const cells = grid.getElementsByClassName('cell');
                for (let i = 0; i < gridSize * gridSize; i++) {
                    const row = Math.floor(i / gridSize);
                    const col = i % gridSize;
                    const pixelIndex = (row * width + col) * 4;

                    if (pixelIndex < imageData.data.length) {
                        const r = imageData.data[pixelIndex];
                        const g = imageData.data[pixelIndex + 1];
                        const b = imageData.data[pixelIndex + 2];
                        const a = imageData.data[pixelIndex + 3];

                        if (a > 0) {
                            const color = `rgb(${r}, ${g}, ${b})`;
                            cells[i].style.backgroundColor = color;
                        } else {
                            cells[i].style.backgroundColor = 'white';
                        }
                    }
                }
            };
            img.src = URL.createObjectURL(file);
        }
    });

    // 画像保存処理
    document.getElementById('download').addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = gridSize * 20;
        canvas.height = gridSize * 20;
        const ctx = canvas.getContext('2d');

        const cells = grid.getElementsByClassName('cell');
        Array.from(cells).forEach((cell, i) => {
            const x = (i % gridSize) * 20;
            const y = Math.floor(i / gridSize) * 20;
            ctx.fillStyle = cell.style.backgroundColor || 'white';
            ctx.fillRect(x, y, 20, 20);
        });

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'dot-art.png';
        link.click();
    });
</script>

</body>
</html>
